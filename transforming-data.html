<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Transforming Data | Using Itrax Data in R</title>
  <meta name="description" content="This book is a guide to importing, tidying, manipulating and analysing Itrax core scanner data in R." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Transforming Data | Using Itrax Data in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book is a guide to importing, tidying, manipulating and analysing Itrax core scanner data in R." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Transforming Data | Using Itrax Data in R" />
  
  <meta name="twitter:description" content="This book is a guide to importing, tidying, manipulating and analysing Itrax core scanner data in R." />
  

<meta name="author" content="Thomas Bishop" />


<meta name="date" content="2020-11-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="plotting.html"/>
<link rel="next" href="multivariate-methods.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Using Itrax Data in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#why-did-i-write-this-book"><i class="fa fa-check"></i><b>0.1</b> Why did I write this book?</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i><b>0.2</b> Prerequisites</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#example-data"><i class="fa fa-check"></i><b>0.3</b> Example Data</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Data Structure</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#metadata"><i class="fa fa-check"></i><b>1.1</b> Metadata</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#xrf-data"><i class="fa fa-check"></i><b>1.2</b> XRF Data</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#optical-images"><i class="fa fa-check"></i><b>1.3</b> Optical Images</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#radiographic-images"><i class="fa fa-check"></i><b>1.4</b> Radiographic Images</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#magnetic-susceptability"><i class="fa fa-check"></i><b>1.5</b> Magnetic Susceptability</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="importing.html"><a href="importing.html"><i class="fa fa-check"></i><b>2</b> Importing Data</a><ul>
<li class="chapter" data-level="2.1" data-path="importing.html"><a href="importing.html#metadata-1"><i class="fa fa-check"></i><b>2.1</b> Metadata</a></li>
<li class="chapter" data-level="2.2" data-path="importing.html"><a href="importing.html#xrf-data-1"><i class="fa fa-check"></i><b>2.2</b> XRF Data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="importing.html"><a href="importing.html#processed-data"><i class="fa fa-check"></i><b>2.2.1</b> Processed Data</a></li>
<li class="chapter" data-level="2.2.2" data-path="importing.html"><a href="importing.html#joining-xrf-data"><i class="fa fa-check"></i><b>2.2.2</b> Joining XRF Data</a></li>
<li class="chapter" data-level="2.2.3" data-path="importing.html"><a href="importing.html#raw-data"><i class="fa fa-check"></i><b>2.2.3</b> Raw Data</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="importing.html"><a href="importing.html#optical-images-1"><i class="fa fa-check"></i><b>2.3</b> Optical Images</a></li>
<li class="chapter" data-level="2.4" data-path="importing.html"><a href="importing.html#radiographic-images-1"><i class="fa fa-check"></i><b>2.4</b> Radiographic Images</a></li>
<li class="chapter" data-level="2.5" data-path="importing.html"><a href="importing.html#magnetic-susceptability-1"><i class="fa fa-check"></i><b>2.5</b> Magnetic Susceptability</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="tidying-data.html"><a href="tidying-data.html"><i class="fa fa-check"></i><b>3</b> Tidying Data</a></li>
<li class="chapter" data-level="4" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>4</b> Plotting</a><ul>
<li class="chapter" data-level="4.1" data-path="plotting.html"><a href="plotting.html#plotting-xrf-data"><i class="fa fa-check"></i><b>4.1</b> Plotting XRF Data</a></li>
<li class="chapter" data-level="4.2" data-path="plotting.html"><a href="plotting.html#plotting-images"><i class="fa fa-check"></i><b>4.2</b> Plotting Images</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="transforming-data.html"><a href="transforming-data.html"><i class="fa fa-check"></i><b>5</b> Transforming Data</a><ul>
<li class="chapter" data-level="5.1" data-path="transforming-data.html"><a href="transforming-data.html#ratios-and-normalisation"><i class="fa fa-check"></i><b>5.1</b> Ratios and Normalisation</a></li>
<li class="chapter" data-level="5.2" data-path="transforming-data.html"><a href="transforming-data.html#preparing-data-for-multivariate-data-analysis"><i class="fa fa-check"></i><b>5.2</b> Preparing Data for Multivariate Data Analysis</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="multivariate-methods.html"><a href="multivariate-methods.html"><i class="fa fa-check"></i><b>6</b> Multivariate Methods</a><ul>
<li class="chapter" data-level="6.1" data-path="multivariate-methods.html"><a href="multivariate-methods.html#correlation-coefficients"><i class="fa fa-check"></i><b>6.1</b> Correlation Coefficients</a></li>
<li class="chapter" data-level="6.2" data-path="multivariate-methods.html"><a href="multivariate-methods.html#unconstrained-cluster-analysis"><i class="fa fa-check"></i><b>6.2</b> Unconstrained Cluster Analysis</a></li>
<li class="chapter" data-level="6.3" data-path="multivariate-methods.html"><a href="multivariate-methods.html#constrained-cluster-analaysis"><i class="fa fa-check"></i><b>6.3</b> Constrained Cluster Analaysis</a></li>
<li class="chapter" data-level="6.4" data-path="multivariate-methods.html"><a href="multivariate-methods.html#principle-components-analysis"><i class="fa fa-check"></i><b>6.4</b> Principle Components Analysis</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="calibrating-data.html"><a href="calibrating-data.html"><i class="fa fa-check"></i><b>7</b> Calibrating Data</a><ul>
<li class="chapter" data-level="7.1" data-path="calibrating-data.html"><a href="calibrating-data.html#suitable-methods"><i class="fa fa-check"></i><b>7.1</b> Suitable Methods</a></li>
<li class="chapter" data-level="7.2" data-path="calibrating-data.html"><a href="calibrating-data.html#linear-methods"><i class="fa fa-check"></i><b>7.2</b> Linear Methods</a></li>
<li class="chapter" data-level="7.3" data-path="calibrating-data.html"><a href="calibrating-data.html#log-ratio-methods"><i class="fa fa-check"></i><b>7.3</b> Log-Ratio Methods</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="exporting-data.html"><a href="exporting-data.html"><i class="fa fa-check"></i><b>8</b> Exporting Data</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Using Itrax Data in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="transforming-data" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Transforming Data</h1>
<p>The XRF data typically reported from the Itrax core scanner come from the spectral processing software Q-Spec. The output is usually in the form of an intensity, which is a dimensionless metric derived from the size of the spectral peak for a particular element, above the background Bremsstralung radiation, sometimes normalised for the tube current and/or counting time.</p>
<div id="ratios-and-normalisation" class="section level2">
<h2><span class="header-section-number">5.1</span> Ratios and Normalisation</h2>
<p>These data are compositional, and represent the changes in the relative proportions of all components of the matrix, measured and un-measured. As such it is likely the data will need transforming for certain types of multivariate analysis. As previously mentioned, these data are dimensionless, and as such do not represent a quantity, but are directly related to the absolute amount of a particular element in the matrix. It is often the case that ratios of elements are used to represent changes in composition — this is sometimes referred to as normalisation, or normalising one element against another.</p>
<p>It is trivial to calculate element ratios, to the extent that these can often simply be calculated where they are required rather than saving them to memory. For example, if a plot of the Compton divided by the Rayleigh scatter was desired, there is no need to save the computed value to a new variable (e.g. <code>coh_inc &lt;- df$Mo.coh/df$Mo.inc</code> ) — simply define the calculation during plotting.</p>
</div>
<div id="preparing-data-for-multivariate-data-analysis" class="section level2">
<h2><span class="header-section-number">5.2</span> Preparing Data for Multivariate Data Analysis</h2>
<p>Where multivariate methods (cluster analysis, principle components analysis, correlation matricies) are required, it is usually necessary to transform data. This is because the statistical assumptions that underlie these methods are often not met when dealing with compositional data like that from an XRF core-scanner. There is no “right” or ideal way to deal with these issues, but a common method is to use a form of log transformation. Here we use a centered log transformation, which cannot be performed on zero values.</p>
<pre><code>df %&gt;% chemometrics::clr(df)</code></pre>
<p>There are a number of possible solutions to this problem of zero values, none ideal, but the most common are to add an arbitary number to the entirity of the data, or to replace zero values with a very small number, perhaps the limit of precision or the limit of detection. In the example shown, the limit of precision for the peak area intensity is used (<code>0.001</code>).</p>
<pre><code>input[input == 0] &lt;- 0.001</code></pre>
<p>A final solution may be to exclude zero values from any subsequent analysis, although not all methods tolerate <code>NA</code> in the data. Where there are many zero values for a particular variable, the variable may not provide good data and could be excluded.</p>
<pre><code>df %&gt;% na_if(0)</code></pre>
<p>In most multivariate analyses there are a number of variables which have high signal-to-noise ratios or otheriwse only add noise to multivariate methods. In these cases, they might be excluded from multivariate methods. The selection of variables for inclusion is a matter for the analyst. It goes without saying that variables that are not part of the composition (that is, anything that is not an element) must be removed from the data used for multivariate analysis.</p>
<pre><code>df %&gt;% select(-any_of(c(&quot;Mg&quot;, &quot;Co&quot;, &quot;Mo&quot;))</code></pre>
<p>Finally, in order to correctly identify the measurements to their original data source, it is necessary to use row names that uniquely identify observations. For single scans this is not usually an issue — the <code>depth</code> or <code>position</code> variable can be used. However, where a dataset is a composition of multiple cores, you may find that there are multiple observations for a particular depth where cores overlap. In the example shown we create a unique name for each observation by concatating the name of the core as recorded in the <code>label</code> column of a core sequence joined using <code>itraxR::itrax_join()</code> with the corresponding <code>depth</code> variable, but the code could be modified to suit a different workflow.</p>
<pre><code>rowlabels &lt;- str_c(df$label, df$depth, sep = &quot;_&quot;)
input &lt;- df %&gt;% select(any_of(elements)) 
input &lt;- input %&gt;% select(-any_of(c(&quot;Mg&quot;, &quot;Co&quot;, &quot;Mo&quot;)))
input[input == 0] &lt;- 0.001

library(chemometrics)
input &lt;- clr(input)

row.names(input) &lt;- rowlabels</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="plotting.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="multivariate-methods.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["itraxBook.pdf", "itraxBook.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
