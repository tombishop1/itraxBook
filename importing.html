<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Importing Data | Using Itrax Data in R</title>
  <meta name="description" content="This book is a guide to importing, tidying, manipulating and analysing Itrax core scanner data in R." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Importing Data | Using Itrax Data in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book is a guide to importing, tidying, manipulating and analysing Itrax core scanner data in R." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Importing Data | Using Itrax Data in R" />
  
  <meta name="twitter:description" content="This book is a guide to importing, tidying, manipulating and analysing Itrax core scanner data in R." />
  

<meta name="author" content="Thomas Bishop" />


<meta name="date" content="2020-11-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html"/>
<link rel="next" href="tidying-data.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Using Itrax Data in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#why-did-i-write-this-book"><i class="fa fa-check"></i><b>0.1</b> Why did I write this book?</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i><b>0.2</b> Prerequisites</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#example-data"><i class="fa fa-check"></i><b>0.3</b> Example Data</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Data Structure</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#metadata"><i class="fa fa-check"></i><b>1.1</b> Metadata</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#xrf-data"><i class="fa fa-check"></i><b>1.2</b> XRF Data</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#optical-images"><i class="fa fa-check"></i><b>1.3</b> Optical Images</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#radiographic-images"><i class="fa fa-check"></i><b>1.4</b> Radiographic Images</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#magnetic-susceptability"><i class="fa fa-check"></i><b>1.5</b> Magnetic Susceptability</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="importing.html"><a href="importing.html"><i class="fa fa-check"></i><b>2</b> Importing Data</a><ul>
<li class="chapter" data-level="2.1" data-path="importing.html"><a href="importing.html#metadata-1"><i class="fa fa-check"></i><b>2.1</b> Metadata</a></li>
<li class="chapter" data-level="2.2" data-path="importing.html"><a href="importing.html#xrf-data-1"><i class="fa fa-check"></i><b>2.2</b> XRF Data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="importing.html"><a href="importing.html#processed-data"><i class="fa fa-check"></i><b>2.2.1</b> Processed Data</a></li>
<li class="chapter" data-level="2.2.2" data-path="importing.html"><a href="importing.html#joining-xrf-data"><i class="fa fa-check"></i><b>2.2.2</b> Joining XRF Data</a></li>
<li class="chapter" data-level="2.2.3" data-path="importing.html"><a href="importing.html#raw-data"><i class="fa fa-check"></i><b>2.2.3</b> Raw Data</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="importing.html"><a href="importing.html#optical-images-1"><i class="fa fa-check"></i><b>2.3</b> Optical Images</a></li>
<li class="chapter" data-level="2.4" data-path="importing.html"><a href="importing.html#radiographic-images-1"><i class="fa fa-check"></i><b>2.4</b> Radiographic Images</a></li>
<li class="chapter" data-level="2.5" data-path="importing.html"><a href="importing.html#magnetic-susceptability-1"><i class="fa fa-check"></i><b>2.5</b> Magnetic Susceptability</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="tidying-data.html"><a href="tidying-data.html"><i class="fa fa-check"></i><b>3</b> Tidying Data</a></li>
<li class="chapter" data-level="4" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>4</b> Plotting</a><ul>
<li class="chapter" data-level="4.1" data-path="plotting.html"><a href="plotting.html#plotting-xrf-data"><i class="fa fa-check"></i><b>4.1</b> Plotting XRF Data</a></li>
<li class="chapter" data-level="4.2" data-path="plotting.html"><a href="plotting.html#plotting-images"><i class="fa fa-check"></i><b>4.2</b> Plotting Images</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="transforming-data.html"><a href="transforming-data.html"><i class="fa fa-check"></i><b>5</b> Transforming Data</a><ul>
<li class="chapter" data-level="5.1" data-path="transforming-data.html"><a href="transforming-data.html#ratios-and-normalisation"><i class="fa fa-check"></i><b>5.1</b> Ratios and Normalisation</a></li>
<li class="chapter" data-level="5.2" data-path="transforming-data.html"><a href="transforming-data.html#preparing-data-for-multivariate-data-analysis"><i class="fa fa-check"></i><b>5.2</b> Preparing Data for Multivariate Data Analysis</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="multivariate-methods.html"><a href="multivariate-methods.html"><i class="fa fa-check"></i><b>6</b> Multivariate Methods</a><ul>
<li class="chapter" data-level="6.1" data-path="multivariate-methods.html"><a href="multivariate-methods.html#correlation-coefficients"><i class="fa fa-check"></i><b>6.1</b> Correlation Coefficients</a></li>
<li class="chapter" data-level="6.2" data-path="multivariate-methods.html"><a href="multivariate-methods.html#unconstrained-cluster-analysis"><i class="fa fa-check"></i><b>6.2</b> Unconstrained Cluster Analysis</a></li>
<li class="chapter" data-level="6.3" data-path="multivariate-methods.html"><a href="multivariate-methods.html#constrained-cluster-analaysis"><i class="fa fa-check"></i><b>6.3</b> Constrained Cluster Analaysis</a></li>
<li class="chapter" data-level="6.4" data-path="multivariate-methods.html"><a href="multivariate-methods.html#principle-components-analysis"><i class="fa fa-check"></i><b>6.4</b> Principle Components Analysis</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="calibrating-data.html"><a href="calibrating-data.html"><i class="fa fa-check"></i><b>7</b> Calibrating Data</a><ul>
<li class="chapter" data-level="7.1" data-path="calibrating-data.html"><a href="calibrating-data.html#suitable-methods"><i class="fa fa-check"></i><b>7.1</b> Suitable Methods</a></li>
<li class="chapter" data-level="7.2" data-path="calibrating-data.html"><a href="calibrating-data.html#linear-methods"><i class="fa fa-check"></i><b>7.2</b> Linear Methods</a></li>
<li class="chapter" data-level="7.3" data-path="calibrating-data.html"><a href="calibrating-data.html#log-ratio-methods"><i class="fa fa-check"></i><b>7.3</b> Log-Ratio Methods</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="exporting-data.html"><a href="exporting-data.html"><i class="fa fa-check"></i><b>8</b> Exporting Data</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Using Itrax Data in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="importing" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Importing Data</h1>
<p>All of the Itrax data is in either text-format or “tagged image format” (<code>*.tif</code>). Although this means it is easily read by the various import functions available in <code>R</code>, it still needs considerable cleaning and wrangling to get it to a point where it is useable for most analyses. There are three possible approaches to this task:</p>
<ol style="list-style-type: decimal">
<li>Use existing functions published in the <code>itraxR</code> package available from <a href="https://github.com/tombishop1/itraxR">github.com/tombishop1</a>. These are at an early stage and functionality might be broken, but are largely convenience functions for wrangling and analysing Itrax data.</li>
<li>Work in base <code>R</code> to wrangle the data. This is perfectly achievable, and much of the current <code>itraxR</code> functionality was written this way.</li>
<li>Work in the <code>tidyverse</code> family of packages and style. For data wrangling tasks, this approach can result in simpler and more resilient code.</li>
</ol>
<p>In this guide examples will be given mostly using the <code>tidyverse</code>, and reference will be made to the convenience functions in <code>itraxR</code>.</p>
<p>All of the Itrax data is in either text-format or “tagged image format” (<code>*.tiff</code>). Although this means it is easily read by the various import functions available in <code>R</code>, it still needs considerable cleaning and wrangling to get it to a point where it is useable. A number of convenience functions are provided in the package <code>itraxR</code>.</p>
<div id="metadata-1" class="section level2">
<h2><span class="header-section-number">2.1</span> Metadata</h2>
<p>The scan data file <code>document.txt</code> can be quickly parsed using <code>itraxR::itrax_meta()</code>. The output is a dataframe from which the individual components can be easily accessed through subsetting functions, for example <code>as.numeric(itrax_meta()[6:7, 2])</code> would return a numeric vector of the start and end position of a scan.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="importing.html#cb1-1"></a><span class="kw">library</span>(itraxR)</span>
<span id="cb1-2"><a href="importing.html#cb1-2"></a><span class="kw">itrax_meta</span>(<span class="st">&quot;CD166_19_S1/CD166_19_S1/document.txt&quot;</span>)</span></code></pre></div>
<pre><code>##                   Parameter       Value       Unit
## 1               Sample name CD166_19_S1        str
## 2              Section name CD166_19_S1        str
## 3           Aquisition date   22/9/2020 dd/mm/yyyy
## 4             Operator name          MC        str
## 5                      Tube          Mo    element
## 6          Start coordinate        31.5         mm
## 7           Stop coordinate      1314.1         mm
## 8                 Step size        1000    microns
## 9             Optical Start         0.5         mm
## 10              Optical End      1401.3         mm
## 11        Optical step size       0.188         mm
## 12             Rad. voltage          55         kV
## 13             Rad. current          50         mA
## 14            Rad. exposure           0         ms
## 15 line camera signal level      323154   at 25 ms
## 16                      XRF          ON     ON/OFF
## 17              XRF voltage          30         kV
## 18              XRF current          30         mA
## 19            XRF exp. time          15    seconds
## 20        Start temperature                  \xb0C
## 21         Stop temperature                  \xb0C
## 22           Start humidity                      %
## 23            Stop humidity                      %
## 24             Start vacuum       -95.0        kPa
## 25              Stop vacuum       -94.8        kPa</code></pre>
</div>
<div id="xrf-data-1" class="section level2">
<h2><span class="header-section-number">2.2</span> XRF Data</h2>
<div id="processed-data" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Processed Data</h3>
<p>This is the data most commonly used in analysis and it can be quickly imported using <code>itraxR::itrax_import()</code>. Note that, like for the example data, it is possible to have more than one processed data file. Typically cores have at least two, one created at the time of the scan based on settings for a single point near the top of the sequence, and another from a holistic re-analysis of the sequence.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="importing.html#cb3-1"></a>CD166_<span class="dv">19</span>_S1 &lt;-<span class="st"> </span><span class="kw">itrax_import</span>(<span class="st">&quot;CD166_19_S1/CD166_19_S1/Results.txt&quot;</span>, <span class="dt">depth =</span> <span class="dv">0</span>)</span>
<span id="cb3-2"><a href="importing.html#cb3-2"></a><span class="kw">head</span>(CD166_<span class="dv">19</span>_S1)</span></code></pre></div>
<pre><code>##   position sample.surface validity   cps  MSE Al  Si P  S   Cl    K     Ca  Sc
## 0    31.54           6.38     TRUE 22415 1.26 41 177 0  0  726 1412  59965  19
## 1    32.54           6.39     TRUE 34525 1.41 76 275 0 10 1318 2565 112734   0
## 2    33.54           6.42     TRUE 38370 1.57 57 306 0  0 1513 2628 144287  14
## 3    34.54           6.42     TRUE 39796 1.55 74 330 0 32 1470 2378 162938   0
## 4    35.54           6.43     TRUE 40022 1.41 26 206 0 21 1312 2265 153194   0
## 5    36.54           6.44     TRUE 41973 1.41 53 233 0 37 1740 2947 135879 106
##     Ti  V  Cr  Mn    Fe  Ni  Cu  Zn Ga Ge  Br  Rb    Sr   Y  Zr Pd Cd  I Cs  Ba
## 0  804 26 220 231 19786  54 117 184  0  0 331 175  5817  60 305  0  9 30  0  35
## 1 1661 51 258 508 35168 123 277 205  4  0 491 329  8306  15 255 31 13 38  0  63
## 2 1806 88 326 559 36494 104 230 268 48 40 605  76  9181 140 322 78 34 48  0  48
## 3 2121 22 301 483 35952 134 150 123  0 43 550 295  9644 119 280 75 55 80  0  25
## 4 2031 75 306 485 35512 144 206 239  0  0 609 313  9940 107 475 66 24 67  0  60
## 5 1826 89 440 738 44303 166 276 240  0  0 659 304 10287 180 160 31 34 23  0 132
##   Nd Sm  Yb  Ta    W  Pb  Bi Mo.inc Mo.coh depth
## 0 12  0 166 546 1151  22   0  20427   6812     0
## 1 17 43 144 789 1992  77  72  26323   8799     1
## 2 67 46 282 776 2019   0 136  26778   9117     2
## 3 44 39 158 703 2016  13 199  26550   9303     3
## 4 75 64 218 794 2160 152 134  28310   9886     4
## 5 42 36 163 919 2344  54 157  31356  10140     5</code></pre>
<p>If you’d like more control over the import process, a typical <code>Tidyverse</code> workflow would consist of reading the file (they are tab-delimited), removing variables that are not of interest, and correctly labelling data that should be <code>NA</code>. You may also wish to assign a coring depth information at this stage.</p>
<p>Firstly, we need to load the packages we will use, and define a list of elements and other names of variables we might expect to find in the files.</p>
<pre><code>library(tidyverse)
library(janitor)

elements &lt;- c( &quot;H&quot;, &quot;He&quot;,
               &quot;Li&quot;, &quot;Be&quot;, &quot;B&quot; , &quot;C&quot; , &quot;N&quot;, &quot;O&quot;, &quot;F&quot; , &quot;Ne&quot;,
               &quot;Na&quot;, &quot;Mg&quot;, &quot;Al&quot;, &quot;Si&quot;, &quot;P&quot;, &quot;S&quot;, &quot;Cl&quot;, # &quot;Ar&quot;,
               &quot;K&quot;, &quot;Ca&quot;, &quot;Sc&quot;, &quot;Ti&quot;, &quot;V&quot;, &quot;Cr&quot;, &quot;Mn&quot;, &quot;Fe&quot;, &quot;Co&quot;, &quot;Ni&quot;, &quot;Cu&quot;, &quot;Zn&quot;, &quot;Ga&quot;, &quot;Ge&quot;, &quot;As&quot;, &quot;Se&quot;, &quot;Br&quot;, &quot;Kr&quot;,
               &quot;Rb&quot;, &quot;Sr&quot;, &quot;Y&quot;, &quot;Zr&quot;, &quot;Nb&quot;, &quot;Mo&quot;, &quot;Tc&quot;, &quot;Ru&quot;, &quot;Rh&quot;, &quot;Pd&quot;, &quot;Ag&quot;, &quot;Cd&quot;, &quot;In&quot;, &quot;Sn&quot;, &quot;Sb&quot;, &quot;Te&quot;, &quot;I&quot;, &quot;Xe&quot;,
               &quot;Cs&quot;, &quot;Ba&quot;,
               &quot;La&quot;, &quot;Ce&quot;, &quot;Pr&quot;, &quot;Nd&quot;, &quot;Pm&quot;, &quot;Sm&quot;, &quot;Eu&quot;, &quot;Gd&quot;, &quot;Tb&quot;, &quot;Dy&quot;, &quot;Ho&quot;, &quot;Er&quot;, &quot;Tm&quot;, &quot;Yb&quot;,
               &quot;Lu&quot;, &quot;Hf&quot;, &quot;Ta&quot;, &quot;W&quot;, &quot;Re&quot;, &quot;Os&quot;, &quot;Ir&quot;, &quot;Pt&quot;, &quot;Au&quot;, &quot;Hg&quot;, &quot;Tl&quot;, &quot;Pb&quot;, &quot;Bi&quot;, &quot;Po&quot;, &quot;At&quot;, &quot;Rn&quot;,
               &quot;Fr&quot;, &quot;Ra&quot;,
               &quot;Ac&quot;, &quot;Th&quot;, &quot;Pa&quot;, &quot;U&quot;, &quot;Np&quot;, &quot;Pu&quot;, &quot;Am&quot;, &quot;Cm&quot;, &quot;Bk&quot;, &quot;Cf&quot;, &quot;Es&quot;, &quot;Fm&quot;, &quot;Md&quot;, &quot;No&quot;,
               &quot;Lr&quot;, &quot;Unq&quot;, &quot;Unp&quot;, &quot;Unh&quot;, &quot;Uns&quot;, &quot;Uno&quot;, &quot;Une&quot;, &quot;Unn&quot; )
others &lt;- c( &quot;position (mm)&quot;, &quot;sample.surface&quot;, &quot;MSE&quot;, &quot;cps&quot;, &quot;validity&quot;, &quot;Mo inc&quot;, &quot;Mo coh&quot;, &quot;Cr inc&quot;, &quot;Cr coh&quot; )</code></pre>
<p>Secondly, we import the file, remove empty rows and columns, and change the data type of the validity flag.</p>
<pre><code>df &lt;- read_tsv(&quot;results.txt&quot;, skip = 2) %&gt;% 
  remove_empty() %&gt;% 
  mutate(validity = as.logical(validity))</code></pre>
<p>Next we can select only the variables we need. The code below leaves anything that is a chemical element or in our list of other useful parameters, but you can change these depending on your needs.</p>
<pre><code>df &lt;- df %&gt;% select(any_of(c(elements, others)))</code></pre>
<p>If you have coring depth information, you could add it now. A simple calculation can be made using the <code>position</code> variable (demonstrated below, here assuming the top of the core is at a depth of 400 mm), or a more advanced calculation as you require. It is also possible to add ages derived from an age/depth model now. The final line re-orders the variables so the <code>depth</code> variable is the first.</p>
<pre><code>df &lt;- df %&gt;% rename(position = `position (mm)`) %&gt;% 
  mutate(depth = position - min(position) + 400) %&gt;% 
  select(depth, everything())</code></pre>
<p>Finally, a quirk of the formatting of data where <code>validity == FALSE</code> needs to be addressed. These cells have a value of 0, but they could be confused with truely <code>0</code> value cells that have <code>validity == TRUE</code>. The solution is to convert them to <code>NA</code> as follows. Note that for metadata variables (<code>depth</code>, <code>sample.surface</code> etc. the measurements are still valid, so should not be set to <code>NA</code>).</p>
<pre><code>df &lt;- full_join(df %&gt;% filter(validity == TRUE), 
                df %&gt;% filter(validity == FALSE) %&gt;% select(any_of(c(elements, &quot;position&quot;))) %&gt;% na_if(0)) %&gt;% 
  arrange(position) %&gt;%
  mutate(depth = df$depth,
         validity = df$validity,
         cps = df$cps,
         MSE = df$MSE)</code></pre>
<p>Finally, you may wish to do some quality control. The deletion criteria will be more fully discussed in the next chapter, but it is often the case that the first and last few measurements are of poor quality. The code below removes the first and last 10 mm of measurements, however depending on your workflow you may wish to simply flag it in some way.</p>
<pre><code>df &lt;- df %&gt;% filter(depth &gt; min(depth) + 10 &amp; depth &lt; max(depth) - 10)</code></pre>
</div>
<div id="joining-xrf-data" class="section level3">
<h3><span class="header-section-number">2.2.2</span> Joining XRF Data</h3>
<p>Ofen a core (sometimes referred to as a drive) is comprised of a sequence of individual sections, which may or may not be overlapping. Often we will want to integrate them into a continuous dataset for analytical purposes. When joining cores that do not overlap, this process is trivial — the data might simply appended in order of depth, and a new column is added with the identity of the original core section.</p>
<p>Where overlapping cores are present, there can be multiple measurements at a single depth (on different cores). In these cases not only will the individual measurements need to be re-ordered by depth, but an additional variable should be created that can be used in combination or alone to uniquely identify each measurement. The code below does this by creating an additional variable called <code>label</code>, with the name of the original core given in the named list.</p>
<pre><code>mylist &lt;- list(core1 = core1, core2 = core2)
df &lt;- lapply(names(mylist), function(i) within(mylist[[i]], {label &lt;- i})) %&gt;% 
  bind_rows() %&gt;% 
  arrange(depth)</code></pre>
<p>This process can be simplified using <code>itraxR::itrax_join()</code>, for example:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="importing.html#cb12-1"></a><span class="co"># import the core sections</span></span>
<span id="cb12-2"><a href="importing.html#cb12-2"></a>CD166_<span class="dv">19</span>_S1 &lt;-<span class="st"> </span><span class="kw">itrax_import</span>(<span class="st">&quot;CD166_19_S1/CD166_19_S1/Results.txt&quot;</span>, <span class="dt">depth_top =</span> <span class="dv">0</span>)</span>
<span id="cb12-3"><a href="importing.html#cb12-3"></a>CD166_<span class="dv">19</span>_S2 &lt;-<span class="st"> </span><span class="kw">itrax_import</span>(<span class="st">&quot;CD166_19_S2/CD166_19_S2/Results.txt&quot;</span>, <span class="dt">depth_top =</span> <span class="kw">max</span>(CD166_<span class="dv">19</span>_S1<span class="op">$</span>depth))</span>
<span id="cb12-4"><a href="importing.html#cb12-4"></a>CD166_<span class="dv">19</span>_S3 &lt;-<span class="st"> </span><span class="kw">itrax_import</span>(<span class="st">&quot;CD166_19_S3/CD166_19_S3/Results.txt&quot;</span>, <span class="dt">depth_top =</span> <span class="kw">max</span>(CD166_<span class="dv">19</span>_S2<span class="op">$</span>depth))</span>
<span id="cb12-5"><a href="importing.html#cb12-5"></a><span class="co">#join them together</span></span>
<span id="cb12-6"><a href="importing.html#cb12-6"></a>CD166_<span class="dv">19</span> &lt;-<span class="st"> </span><span class="kw">itrax_join</span>(<span class="kw">list</span>(<span class="dt">S1 =</span> CD166_<span class="dv">19</span>_S1, <span class="dt">S2 =</span> CD166_<span class="dv">19</span>_S2, <span class="dt">S3 =</span> CD166_<span class="dv">19</span>_S3))</span></code></pre></div>
<pre><code>## Loading required package: dplyr</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="importing.html#cb17-1"></a><span class="kw">str</span>(CD166_<span class="dv">19</span>)</span></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    4212 obs. of  44 variables:
##  $ position      : num  31.5 32.5 33.5 34.5 35.5 ...
##  $ sample.surface: num  6.38 6.39 6.42 6.42 6.43 6.44 6.46 6.47 6.48 6.49 ...
##  $ validity      : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
##  $ cps           : int  22415 34525 38370 39796 40022 41973 41268 40977 41104 41408 ...
##  $ MSE           : num  1.26 1.41 1.57 1.55 1.41 1.41 1.36 1.52 1.38 1.58 ...
##  $ Al            : int  41 76 57 74 26 53 27 72 78 69 ...
##  $ Si            : int  177 275 306 330 206 233 347 337 346 403 ...
##  $ P             : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ S             : int  0 10 0 32 21 37 28 59 19 44 ...
##  $ Cl            : int  726 1318 1513 1470 1312 1740 1576 1605 1559 1503 ...
##  $ K             : int  1412 2565 2628 2378 2265 2947 3179 3376 3193 3220 ...
##  $ Ca            : int  59965 112734 144287 162938 153194 135879 132183 134094 138570 145762 ...
##  $ Sc            : int  19 0 14 0 0 106 14 0 46 0 ...
##  $ Ti            : int  804 1661 1806 2121 2031 1826 1923 2059 2443 2701 ...
##  $ V             : int  26 51 88 22 75 89 107 0 71 23 ...
##  $ Cr            : int  220 258 326 301 306 440 401 440 407 449 ...
##  $ Mn            : int  231 508 559 483 485 738 792 799 868 794 ...
##  $ Fe            : int  19786 35168 36494 35952 35512 44303 45283 45694 46506 47859 ...
##  $ Ni            : int  54 123 104 134 144 166 151 125 157 180 ...
##  $ Cu            : int  117 277 230 150 206 276 250 217 178 191 ...
##  $ Zn            : int  184 205 268 123 239 240 294 284 238 230 ...
##  $ Ga            : int  0 4 48 0 0 0 40 8 22 26 ...
##  $ Ge            : int  0 0 40 43 0 0 48 115 100 80 ...
##  $ Br            : int  331 491 605 550 609 659 709 583 582 635 ...
##  $ Rb            : int  175 329 76 295 313 304 318 337 323 223 ...
##  $ Sr            : int  5817 8306 9181 9644 9940 10287 9917 9931 9897 9209 ...
##  $ Y             : int  60 15 140 119 107 180 106 52 77 112 ...
##  $ Zr            : int  305 255 322 280 475 160 312 319 319 552 ...
##  $ Pd            : int  0 31 78 75 66 31 72 31 54 58 ...
##  $ Cd            : int  9 13 34 55 24 34 28 56 62 96 ...
##  $ I             : int  30 38 48 80 67 23 58 30 53 93 ...
##  $ Cs            : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ Ba            : int  35 63 48 25 60 132 93 172 108 108 ...
##  $ Nd            : int  12 17 67 44 75 42 97 92 68 56 ...
##  $ Sm            : int  0 43 46 39 64 36 12 24 69 68 ...
##  $ Yb            : int  166 144 282 158 218 163 184 248 166 188 ...
##  $ Ta            : int  546 789 776 703 794 919 852 926 840 847 ...
##  $ W             : int  1151 1992 2019 2016 2160 2344 2336 2243 2267 2185 ...
##  $ Pb            : int  22 77 0 13 152 54 54 75 111 78 ...
##  $ Bi            : int  0 72 136 199 134 157 182 151 185 116 ...
##  $ Mo.inc        : int  20427 26323 26778 26550 28310 31356 30631 29040 29104 27932 ...
##  $ Mo.coh        : int  6812 8799 9117 9303 9886 10140 9968 9973 9701 9751 ...
##  $ depth         : num  0 1 2 3 4 5 6 7 8 9 ...
##  $ label         : chr  &quot;S1&quot; &quot;S1&quot; &quot;S1&quot; &quot;S1&quot; ...</code></pre>
</div>
<div id="raw-data" class="section level3">
<h3><span class="header-section-number">2.2.3</span> Raw Data</h3>
<p>Sometimes it is useful to work with raw data rather than the calculated intensity data from the <code>Q-Spec</code> software. In this case, the raw data can be read directly from the individual files in the relevant directory. For individual measurements this is fairly trivial, although it must be considered that the data output is not calibrated to an energy and the data are in counts, not intensities. If the entire scan is read, some mechanism to iterate through the individual data files, adding them to a structured data object with relevant metadata (positions, for example) is required.</p>
</div>
</div>
<div id="optical-images-1" class="section level2">
<h2><span class="header-section-number">2.3</span> Optical Images</h2>
<p>In order to make the images usable for plotting beside other data, they need to be cropped to the scanned area and referenced to the <code>position</code> or a <code>depth</code> variable. Images in <code>R</code> are read in as a matrix with 3 dimensions (length, width, and the three colours).</p>
<p>To begin with the start and end positions of the scan need to be established; this usually involves parsing the metadata file (e.g. <code>itraxR::itrax_meta()[]</code>), although in some circumstances they can be obtained from another data source (e.g. <code>range(myData[,"Position"])</code>). These then need to be mapped onto individual pixel values using the known size of a single pixel. Once this has been calculated, it is trvial to then subset the part of the image required.</p>
<pre><code>library(itraxR)
library(tiff)

image &lt;- readTIFF(&quot;optical.tif&quot;)
meta &lt;- itrax_meta(&quot;document.txt&quot;)

image_depth &lt;- rev(seq(from = as.numeric(meta[9, 2]),
                   to = as.numeric(meta[10, 2]),
                   length.out = dim(image)[2]))

image &lt;- image[ , which(image_depth &gt; as.numeric(meta[6, 2]) &amp; image_depth &lt; as.numeric(meta[7, 2])) , ]
</code></pre>
</div>
<div id="radiographic-images-1" class="section level2">
<h2><span class="header-section-number">2.4</span> Radiographic Images</h2>
<p>The workflow for manipulating the processed radiographic images (<code>*.tif</code>) is very similar to that for the optical images, the main difference being the matrix only has two dimensions (length and width) as the image is greyscale. However, if there is a desire to manipulate the raw data from the radiographic image, some further work is required because the “pixel” is not square, but rectangular. That is to say the length of the pixel differs from its width. On the core scanner a single pixel has a width across the core of 20 micrometers, but has a variable coverage along the core (usually between 50 and 200 micrometers). The processed image downscales the pixel width to match the pixel length in order to force square pixels, losing some resolution along the way.</p>
<p>In addition, it should be noted that unlike the optical images that always begin from <code>position == 0</code>, the radiographic images have defined start and end points just like an XRF scan, the parameters of which can be accessed from the <code>document.txt</code> metadata file (or by using <code>itrax_meta()</code>).</p>
</div>
<div id="magnetic-susceptability-1" class="section level2">
<h2><span class="header-section-number">2.5</span> Magnetic Susceptability</h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="tidying-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["itraxBook.pdf", "itraxBook.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
